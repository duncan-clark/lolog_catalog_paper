---
output:
  md_document:
    variant: gfm
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "figures/",
  dev = "png",
  dpi = 150,
  fig.asp = 0.8,
  fig.width = 10,
  out.width = "60%",
  fig.align = "center"
)
```


<img src="figures/ps_statistics_DoS.png" width = 200 alt="DoS Logo"/>[<img src="figures/statnetLogo.png" align="right" width=100 alt="statnet
Logo"/>](https://github.com/statnet)

<br>
<br>
<center> <h3>Comparing the Real-World Performance of Exponential-family Random Graph Models</h3></center>

```{r,include=FALSE}
set.seed(294)
```

This site contain code and software to reproduce example analyses from the paper 
``Comparing the Real-World Performance of Exponential family Random Graph Models and Latent Order Logistic Models'' by Duncan A. Clark and  Mark
S. Handcock, Department of Statistics at UCLA.

### Installation 

First, install the version of the ergm package used to produce the paper.
This requires the `statnet.common_4.2.0.tar.gz`, `network_1.15.tar.gz` and `ergm_3.9.4.tar.gz`
source code included here.
Then install the included LOLOG extension package `LologExtension_1.0.tar.gz` from source.

### Processing the raw publicly available network

Run the script to process the `.gexf` file for the network,
and adds covariates from the covariates from the covariate.csv file
additional objects are created for the purpose of modelling edge attributes.

```{r, eval = FALSE}
source("processing.R")
```

This produces the `processed_data.RData` data set.
 
### Case study: German Schoolboys network

First load some necessary packages:

```{r, message = FALSE}
library("ergm")
library("lolog")
```

```{r, eval = TRUE}
# extended LOLOG package included as tar.gz for the fitting of cyclic triples
library("LologExtension")
```
Load the German Schoolboys network data in its processed form: 

```{r, eval = TRUE}
load("processed_data.RData")
```

Load the Utility Functions for fitting and GOF procedure 

```{r, eval = TRUE}
source("utility_functions.R")
```

0) Start with dyad independent model to see if this fits adequately:

```{r, fig0,fig.cap="\\label{fig:fig0}Goodness-of-fit for ergm_fit_1_0",echo=TRUE}
ergm_fit_1_0 <- ergm_fit(net,
                         terms = c("edges",
                                   "nodeicov('handicapped')",
                                   "nodeocov('handicapped')",
                                   "nodeicov('sweetgiver')",
                                   "nodeocov('sweetgiver')",
                                   "nodeicov('rank')",
                                   "nodeocov('rank')",
                                   "nodeicov('repeater')",
                                   "nodeocov('repeater')"),
                         gofit_terms = c("edges","degree(0:25)","esp(0:15)"),
                         gofit_name = "ergm_1_0")
```

See that fit isn't very good:

```{r, fig0_gof,fig.cap="\\label{fig:fig0_gof}Goodness-of-fit for ergm_fit_1_0",echo=TRUE}
plot(ergm_fit_1_0$gofit)
```
Seems that rank and repeater are the main covariate to have an effect
Possible sweetgiver also has an effect but since there is only one sweetgiver in 
the network the parameter MLE has a high s.d. and is not significant.

Does not fit well
Bad fit on degree and esp 

1) Model 1 in paper

Fit as in paper to replicate table 1 Markov model:

```{r, eval = TRUE}
ergm_fit_1_1 <- ergm_fit(net,
                         terms = c("edges",
                                   "nodeicov('repeater_or_sweets')",
                                   "nodeicov('handicapped')",
                                   "nodeicov('rank')",
                                   "nodeocov('rank')",
                                   "absdiff('rank')",
                                   "gwesp()",
                                   "mutual",
                                   "cycle(3)",
                                   "m2star"),
                         gofit_terms = c("edges","degree(0:25)","esp(0:15)"),
                         gofit_name = "ergm_1_1")
```

Comment on fit :
same as model in paper - managed to match!

Much improved fit on esp and min distance,slight improvement on in and out degree fit.

2) Model 2 in paper

Fit as in paper with uprank statistic to match results
```{r, eval = TRUE}
ergm_fit_1_2 <- ergm_fit(net,
                         terms = c("edges",
                                   "nodeicov('repeater_or_sweets')",
                                   "nodeicov('handicapped')",
                                   "nodeicov('rank')",
                                   #"nodeocov('rank')",
                                   "edgecov(edges_adj_uprank)",
                                   "absdiff('rank')",
                                   "gwesp()",
                                   "mutual",
                                   "cycle(3)",
                                   "m2star"),
                         gofit_terms = c("edges","degree(0:25)","esp(0:15)"),
                         gofit_name = "ergm_1_2")
```

Similar to fit of model 1

3) Model 3 in paper
```{r, eval = TRUE}
ergm_fit_1_3 <- ergm_fit(net,
                         terms = c("edges",
                                   "nodeicov('repeater_or_sweets')",
                                   "nodeicov('handicapped')",
                                   "nodeicov('rank')",
                                   "nodeocov('rank')",
                                   "edgecov(edges_adj_uprank)",
                                   "absdiff('rank')",
                                   "gwesp()",
                                   "mutual",
                                   "cycle(3)",
                                   "m2star"),
                         gofit_terms = c("edges","degree(0:25)","esp(0:15)"),
                         gofit_name = "ergm_1_3")
```

Similar to fit of model 1

4) Include popularity terms this time

We suspect this might make some of the other covariate estimates not significant:
```{r, eval = TRUE}
ergm_fit_1_4 <- ergm_fit(net,
                         terms = c("edges",
                                   "nodeicov('repeater_or_sweets')",
                                   "nodeicov('handicapped')",
                                   "nodeicov('rank')",
                                   "nodeocov('rank')",
                                   "edgecov(edges_adj_uprank)",
                                   "absdiff('rank')",
                                   "gwesp()",
                                   "gwidegree(fixed = FALSE)",
                                   "gwodegree(fixed = FALSE)",
                                   "mutual",
                                   "cycle(3)",
                                   "m2star"),
                         gofit_terms = c("edges","degree(0:25)","esp(0:15)"),
                         gofit_name = "ergm_1_4")
```

ESP and minimum distance fit similar to model 1, slight improvement on in and out degree fit
It may suggest some popularity process not captured by model 1

5) Check to see if triangle and star model is degenerative:
```{r, eval = TRUE}
ergm_5 <- function(net,MCMC.samplesize,seed=1){
  tmp <- ergm(net ~ nodeicov("rank")+
                nodeicov("repeater_or_sweets")+
                nodeicov("handicapped")+
                nodeocov("rank")+
                edgecov(edges_adj_uprank)+
                absdiff("rank")+
                ttriple+
                mutual+
                cycle(3)+
                m2star+
                istar(c(2,3,4))+
                ostar(c(2,3,4))+
                edges,
              estimate = "MLE",
              control = control.ergm(seed = seed,MCMC.samplesize =MCMC.samplesize))
  return(tmp)
}


```{r, eval = FALSE}
ergm_1_5 <- ergm_5(net,2**10,seed = 2)
summary(ergm_1_5)
gof_plot(ergm_1_5)
```
This did not converge - ergm degenerate

6) Model 2 in paper but with g weighted degrees instead of triangles
```{r, eval = TRUE}
ergm_fit_1_6 <- ergm_fit(net,
                         terms = c("edges",
                                   "nodeicov('repeater_or_sweets')",
                                   "nodeicov('handicapped')",
                                   "nodeicov('rank')",
                                   "nodeocov('rank')",
                                   "edgecov(edges_adj_uprank)",
                                   "absdiff('rank')",
                                   #"gwesp()",
                                   "gwidegree(fixed = FALSE)",
                                   "gwodegree(fixed = FALSE)",
                                   "mutual",
                                   "cycle(3)",
                                   "m2star"),
                         gofit_terms = c("edges","degree(0:25)","esp(0:15)"),
                         gofit_name = "ergm_1_6")
```

Key is to check whether this model captures the ESP distribution, since if it does
the ESP distribution may not be due to transitive closure.

Captures degree distribution arguably better than models with gwesp term.
ESP distribution fits somewhat, though issues with esp 0 and 2, so perhaps does not account for these well

### LOLOG Fitting 

0) Fit initial LOLOG model with dyad independence
```{r, eval = TRUE}
lolog_fit_1_0 <- lolog_fit(net,
                         terms = c("edges",
                                   "nodeCov('handicapped_in','in')",
                                   "nodeCov('handicapped_out','out')",
                                   "nodeCov('sweetgiver_in','in')",
                                   "nodeCov('sweetgiver_out','out')",
                                   "nodeCov('rank_in','in')",
                                   "nodeCov('rank_out','out')",
                                   "nodeCov('repeater_in','in')",
                                   "nodeCov('repeater_out','out')"
                                   ),
                         gofit_terms = c("edges","degree(0:25)","esp(0:15)"),
                         gofit_name = "lolog_1_0")
```

It is the same as dyad independent ergm - fit poor as expected!

1) Add parameters in paper model 1
```{r, eval = FALSE}
lolog_fit_1_1 <- lolog_fit(net,
                            terms = c("edges",
                                      "nodeCov('repeater_or_sweets_in','in')",
                                      "nodeCov('handicapped_in','in')",
                                      "nodeCov('rank_in','in')",
                                      "nodeCov('rank_out','out')",
                                      "edgeCov(edges_adj_rankdiff,'rankdiff')",
                                      #"edgeCov(edges_adj_uprank,'uprank')",
                                      "gwesp(0.5)",
                                      "mutual",
                                      "cTriple",
                                      "twoPath"),
                            gofit_terms = c("edges","degree(0:25)","esp(0:15)"),
                            gofit_name = "lolog_1_1")
```

Comments: This did not converge

Replace gwesp term with triangles 
```{r, eval = TRUE}
lolog_fit_1_1 <- lolog_fit(net,
                           terms = c("edges",
                                     "nodeCov('repeater_or_sweets_in','in')",
                                     "nodeCov('handicapped_in','in')",
                                     "nodeCov('rank_in','in')",
                                     "nodeCov('rank_out','out')",
                                     "edgeCov(edges_adj_rankdiff,'rankdiff')",
                                     #"edgeCov(edges_adj_uprank,'uprank')",
                                     #"gwesp(0.5)",
                                     "triangles",
                                     "mutual",
                                     "cTriple",
                                     "twoPath"),
                           gofit_terms = c("edges","degree(0:15,'out')","degree(0:15,'in')","esp(0:15)"),
                           gofit_name = "lolog_1_1")
```

2) Add terms in paper model 2
```{r, eval = FALSE}
lolog_fit_1_2 <- lolog_fit(net,
                            terms = c("edges",
                                      "nodeCov('repeater_or_sweets_in','in')",
                                      "nodeCov('handicapped_in','in')",
                                      #"nodeCov('rank_in','in')",
                                      "nodeCov('rank_out','out')",
                                      "edgeCov(edges_adj_rankdiff,'rankdiff')",
                                      "edgeCov(edges_adj_uprank,'uprank')",
                                      "gwesp(0.5)",
                                      "mutual",
                                      "cTriple",
                                      "twoPath"),
                            gofit_terms = c("edges","degree(0:25)","esp(0:15)"),
                            gofit_name = "lolog_1_2")
```

Comment: This did not converge

Replace gwesp term with triangles 
```{r, eval = TRUE}
lolog_fit_1_2 <- lolog_fit(net,
                           terms = c("edges",
                                     "nodeCov('repeater_or_sweets_in','in')",
                                     "nodeCov('handicapped_in','in')",
                                     #"nodeCov('rank_in','in')",
                                     "nodeCov('rank_out','out')",
                                     "edgeCov(edges_adj_rankdiff,'rankdiff')",
                                     "edgeCov(edges_adj_uprank,'uprank')",
                                     #"gwesp(0.5)",
                                     "triangles",
                                     "mutual",
                                     "cTriple",
                                     "twoPath"),
                           gofit_terms = c("edges","degree(0:15,'out')","degree(0:15,'in')","esp(0:15)"),
                           gofit_name = "lolog_1_2")
```

3)Add terms in paper model 3
```{r, eval = FALSE}
lolog_fit_1_3 <- lolog_fit(net,
                           terms = c("edges",
                                     "nodeCov('repeater_or_sweets_in','in')",
                                     "nodeCov('handicapped_in','in')",
                                     "nodeCov('rank_in','in')",
                                     "nodeCov('rank_out','out')",
                                     "edgeCov(edges_adj_rankdiff,'rankdiff')",
                                     "edgeCov(edges_adj_uprank,'uprank')",
                                     "gwesp(0.5)",
                                     "mutual",
                                     "cTriple",
                                     "twoPath"),
                           gofit_terms = c("edges","degree(0:25)","esp(0:15)"),
                           gofit_name = "lolog_1_3")
```

Replace gwesp term with triangles 
```{r, eval = TRUE}
lolog_fit_1_3 <- lolog_fit(net,
                           terms = c("edges",
                                     "nodeCov('repeater_or_sweets_in','in')",
                                     "nodeCov('handicapped_in','in')",
                                     "nodeCov('rank_in','in')",
                                     "nodeCov('rank_out','out')",
                                     "edgeCov(edges_adj_rankdiff,'rankdiff')",
                                     "edgeCov(edges_adj_uprank,'uprank')",
                                     #"gwesp(0.5)",
                                     "triangles",
                                     "mutual",
                                     "cTriple",
                                     "twoPath"),
                           gofit_terms = c("edges","degree(0:15,'out')","degree(0:15,'in')","esp(0:15)"),
                           gofit_name = "lolog_1_3")
```

4) Lolog fitting procedure

Keep all covariate terms in model

Fit just with  triangles and mutual
```{r, eval = TRUE}
lolog_fit_1_4 <- lolog_fit(net,
                           terms = c("edges",
                                     "nodeCov('repeater_or_sweets_in','in')",
                                     "nodeCov('handicapped_in','in')",
                                     "nodeCov('rank_in','in')",
                                     "nodeCov('rank_out','out')",
                                     "edgeCov(edges_adj_rankdiff,'rankdiff')",
                                     "edgeCov(edges_adj_uprank,'uprank')",
                                     "triangles",
                                     "mutual"),
                           gofit_terms = c("edges","degree(0:15,'out')","degree(0:15,'in')","esp(0:15)"),
                           gofit_name = "lolog_1_4")
```

5) Fit with just 2,3 stars
```{r, eval = TRUE}
lolog_fit_1_5 <- lolog_fit(net,
                           terms = c("edges",
                                     "nodeCov('repeater_or_sweets_in','in')",
                                     "nodeCov('handicapped_in','in')",
                                     "nodeCov('rank_in','in')",
                                     "nodeCov('rank_out','out')",
                                     "edgeCov(edges_adj_rankdiff,'rankdiff')",
                                     "edgeCov(edges_adj_uprank,'uprank')",
                                     "star(c(2,3))",
                                     "mutual"),
                           gofit_terms = c("edges","degree(0:15,'out')","degree(0:15,'in')","esp(0:15)"),
                           gofit_name = "lolog_1_5")
```

6) Fit with just 2,3,4,5 stars
```{r, eval = TRUE}
lolog_fit_1_6 <- lolog_fit(net,
                           terms = c("edges",
                                     "nodeCov('repeater_or_sweets_in','in')",
                                     "nodeCov('handicapped_in','in')",
                                     "nodeCov('rank_in','in')",
                                     "nodeCov('rank_out','out')",
                                     "edgeCov(edges_adj_rankdiff,'rankdiff')",
                                     "edgeCov(edges_adj_uprank,'uprank')",
                                     "star(c(2,3,4,5))",
                                     "mutual"),
                           gofit_terms = c("edges","degree(0:15,'out')","degree(0:15,'in')","esp(0:15)"),
                           gofit_name = "lolog_1_6")
```


7) Fit with triangles and 2 and 3 stars
```{r, eval = TRUE}
lolog_fit_1_7 <- lolog_fit(net,
                           terms = c("edges",
                                     "nodeCov('repeater_or_sweets_in','in')",
                                     "nodeCov('handicapped_in','in')",
                                     "nodeCov('rank_in','in')",
                                     "nodeCov('rank_out','out')",
                                     "edgeCov(edges_adj_rankdiff,'rankdiff')",
                                     "edgeCov(edges_adj_uprank,'uprank')",
                                     "triangles",
                                     "star(c(2,3))",
                                     "mutual"),
                           gofit_terms = c("edges","degree(0:15,'out')","degree(0:15,'in')","esp(0:15)"),
                           gofit_name = "lolog_1_7")
```

8) Fit with triangles and 2,3,4 and 5 stars
```{r, eval = TRUE}
lolog_fit_1_8 <- lolog_fit(net,
                           terms = c("edges",
                                     "nodeCov('repeater_or_sweets_in','in')",
                                     "nodeCov('handicapped_in','in')",
                                     "nodeCov('rank_in','in')",
                                     "nodeCov('rank_out','out')",
                                     "edgeCov(edges_adj_rankdiff,'rankdiff')",
                                     "edgeCov(edges_adj_uprank,'uprank')",
                                     "triangles",
                                     "star(c(2,3,4,5))",
                                     "mutual"),
                           gofit_terms = c("edges","degree(0:15,'out')","degree(0:15,'in')","esp(0:15)"),
                           gofit_name = "lolog_1_8")
```

9) Fit with triangles, 2,3 stars and cTriples
```{r, eval = TRUE}
lolog_fit_1_9 <- lolog_fit(net,
                           terms = c("edges",
                                     "nodeCov('repeater_or_sweets_in','in')",
                                     "nodeCov('handicapped_in','in')",
                                     "nodeCov('rank_in','in')",
                                     "nodeCov('rank_out','out')",
                                     "edgeCov(edges_adj_rankdiff,'rankdiff')",
                                     "edgeCov(edges_adj_uprank,'uprank')",
                                     "triangles",
                                     "star(c(2,3))",
                                     "cTriple",
                                     "mutual"),
                           gofit_terms = c("edges","degree(0:15,'out')","degree(0:15,'in')","esp(0:15)"),
                           gofit_name = "lolog_1_9")
```

10) Fit with triangles, 2,3 stars and twoPaths
```{r, eval = TRUE}
lolog_fit_1_10 <- lolog_fit(net,
                           terms = c("edges",
                                     "nodeCov('repeater_or_sweets_in','in')",
                                     "nodeCov('handicapped_in','in')",
                                     "nodeCov('rank_in','in')",
                                     "nodeCov('rank_out','out')",
                                     "edgeCov(edges_adj_rankdiff,'rankdiff')",
                                     "edgeCov(edges_adj_uprank,'uprank')",
                                     "triangles",
                                     "star(c(2,3))",
                                     "twoPaths",
                                     "mutual"),
                           gofit_terms = c("edges","degree(0:15,'out')","degree(0:15,'in')","esp(0:15)"),
                           gofit_name = "lolog_1_10")
```
11) Fit with triangles, 2,3 stars and twoPaths and cTriple
```{r, eval = TRUE}
lolog_fit_1_11 <- lolog_fit(net,
                           terms = c("edges",
                                     "nodeCov('repeater_or_sweets_in','in')",
                                     "nodeCov('handicapped_in','in')",
                                     "nodeCov('rank_in','in')",
                                     "nodeCov('rank_out','out')",
                                     "edgeCov(edges_adj_rankdiff,'rankdiff')",
                                     "edgeCov(edges_adj_uprank,'uprank')",
                                     "triangles",
                                     "star(c(2,3))",
                                     "cTriple",
                                     "twoPaths",
                                     "mutual"),
                           gofit_terms = c("edges","degree(0:15,'out')","degree(0:15,'in')","esp(0:15)"),
                           gofit_name = "lolog_1_11")
```

Cannot have both triangles two paths

12) Fit with star(2,3), twoPaths, 
```{r, eval = TRUE}
lolog_fit_1_12 <- lolog_fit(net,
                            terms = c("edges",
                                      "nodeCov('repeater_or_sweets_in','in')",
                                      "nodeCov('handicapped_in','in')",
                                      "nodeCov('rank_in','in')",
                                      "nodeCov('rank_out','out')",
                                      "edgeCov(edges_adj_rankdiff,'rankdiff')",
                                      "edgeCov(edges_adj_uprank,'uprank')",
                                      "star(c(2,3))",
                                      "twoPaths",
                                      "mutual"),
                            gofit_terms = c("edges","degree(0:15,'out')","degree(0:15,'in')","esp(0:15)"),
                            gofit_name = "lolog_1_11")
```

13) Fit with star(c(2,3)), and twoPaths and cTriple
```{r, eval = TRUE}
lolog_fit_1_13 <- lolog_fit(net,
                            terms = c("edges",
                                      "nodeCov('repeater_or_sweets_in','in')",
                                      "nodeCov('handicapped_in','in')",
                                      "nodeCov('rank_in','in')",
                                      "nodeCov('rank_out','out')",
                                      "edgeCov(edges_adj_rankdiff,'rankdiff')",
                                      "edgeCov(edges_adj_uprank,'uprank')",
                                      "star(c(2,3))",
                                      "cTriple",
                                      "twoPaths",
                                      "mutual"),
                            gofit_terms = c("edges","degree(0:15,'out')","degree(0:15,'in')","esp(0:15)"),
                            gofit_name = "lolog_1_13")
```

14) Try to fit with transitive triples
```{r, eval = TRUE}
lolog_fit_1_14 <- lolog_fit(net,
                            terms = c("edges",
                                      "nodeCov('repeater_or_sweets_in','in')",
                                      "nodeCov('handicapped_in','in')",
                                      "nodeCov('rank_in','in')",
                                      "nodeCov('rank_out','out')",
                                      "edgeCov(edges_adj_rankdiff,'rankdiff')",
                                      "edgeCov(edges_adj_uprank,'uprank')",
                                      #"triangles",
                                      #"star(c(2,3))",
                                      #"cTriple",
                                      #"twoPaths",
                                      "tTriple",
                                      "mutual"),
                            gofit_terms = c("edges","degree(0:15,'out')","degree(0:15,'in')","esp(0:15)"),
                            gofit_name = "lolog_1_14")
```

15) Try to fit with transitive triples
```{r, eval = TRUE}
lolog_fit_1_15 <- lolog_fit(net,
                            terms = c("edges",
                                      "nodeCov('repeater_or_sweets_in','in')",
                                      "nodeCov('handicapped_in','in')",
                                      "nodeCov('rank_in','in')",
                                      "nodeCov('rank_out','out')",
                                      "edgeCov(edges_adj_rankdiff,'rankdiff')",
                                      "edgeCov(edges_adj_uprank,'uprank')",
                                      #"triangles",
                                      "star(c(2,3))",
                                      #"cTriple",
                                      #"twoPaths",
                                      "tTriple",
                                      "mutual"),
                            gofit_terms = c("edges","degree(0:15,'out')","degree(0:15,'in')","esp(0:15)"),
                            gofit_name = "lolog_1_15")
```

16) Try to fit with transitive triples
```{r, eval = TRUE}
lolog_fit_1_16 <- lolog_fit(net,
                            terms = c("edges",
                                      "nodeCov('repeater_or_sweets_in','in')",
                                      "nodeCov('handicapped_in','in')",
                                      "nodeCov('rank_in','in')",
                                      "nodeCov('rank_out','out')",
                                      "edgeCov(edges_adj_rankdiff,'rankdiff')",
                                      "edgeCov(edges_adj_uprank,'uprank')",
                                      #"triangles",
                                      "star(c(2,3))",
                                      "cTriple",
                                      #"twoPaths",
                                      "tTriple",
                                      "mutual"),
                            gofit_terms = c("edges","degree(0:15,'out')","degree(0:15,'in')","esp(0:15)"),
                            gofit_name = "lolog_1_16")
```

17) Try to fit with transitive triples
```{r, eval = TRUE}
lolog_fit_1_17 <- lolog_fit(net,
                            terms = c("edges",
                                      "nodeCov('repeater_or_sweets_in','in')",
                                      "nodeCov('handicapped_in','in')",
                                      "nodeCov('rank_in','in')",
                                      "nodeCov('rank_out','out')",
                                      "edgeCov(edges_adj_rankdiff,'rankdiff')",
                                      "edgeCov(edges_adj_uprank,'uprank')",
                                      "triangles",
                                      "star(c(2,3))",
                                      "cTriple",
                                      #"twoPaths",
                                      "tTriple",
                                      "mutual"),
                            gofit_terms = c("edges","degree(0:15,'out')","degree(0:15,'in')","esp(0:15)"),
                            gofit_name = "lolog_1_17")
```

18) Fit with preferential attachment term, fitting with star(2,3) and triangle terms
```{r, eval = TRUE}
lolog_fit_1_18 <- lolog_fit(net,
                            terms = c("edges",
                                      "nodeCov('repeater_or_sweets_in','in')",
                                      "nodeCov('handicapped_in','in')",
                                      "nodeCov('rank_in','in')",
                                      "nodeCov('rank_out','out')",
                                      "edgeCov(edges_adj_rankdiff,'rankdiff')",
                                      "edgeCov(edges_adj_uprank,'uprank')",
                                      #"star(c(2,3))",
                                      #"cTriple",
                                      #"twoPaths",
                                      "mutual",
                                      "preferentialAttachment(1)"),
                            gofit_terms = c("edges","degree(0:15,'out')","degree(0:15,'in')","esp(0:15)"),
                            fit_terms = c("star(c(2,3))","triangles"),
                            gofit_name = "lolog_1_18")
```

This does not converge.

19) Fit with preferential attachment term, fitting with star(2,3), including triangle term in model
```{r, eval = TRUE}
lolog_fit_1_19 <- lolog_fit(net,
                            terms = c("edges",
                                      "nodeCov('repeater_or_sweets_in','in')",
                                      "nodeCov('handicapped_in','in')",
                                      "nodeCov('rank_in','in')",
                                      "nodeCov('rank_out','out')",
                                      "edgeCov(edges_adj_rankdiff,'rankdiff')",
                                      "edgeCov(edges_adj_uprank,'uprank')",
                                      "triangles",
                                      #"star(c(2,3))",
                                      #"cTriple",
                                      #"twoPaths",
                                      "mutual",
                                      "preferentialAttachment(1)"),
                            gofit_terms = c("edges","degree(0:15,'out')","degree(0:15,'in')","esp(0:15)"),
                            fit_terms = c("star(c(2,3))"),
                            gofit_name = "lolog_1_19")
```

This does not converge

20) Fit with preferential attachment term, fitting with star(2,3), including triangle term in model

Try with higher values of k:
* 1  - didn't work
* 10 - didn't work
* 15 - didn't work
* 5  - didn't work
* 2  - didn't work

```{r, eval = TRUE}
lolog_fit_1_20 <- lolog_fit(net,
                            terms = c("edges",
                                      "nodeCov('repeater_or_sweets_in','in')",
                                      "nodeCov('handicapped_in','in')",
                                      "nodeCov('rank_in','in')",
                                      "nodeCov('rank_out','out')",
                                      "edgeCov(edges_adj_rankdiff,'rankdiff')",
                                      "edgeCov(edges_adj_uprank,'uprank')",
                                      "triangles",
                                      #"star(c(2,3))",
                                      #"cTriple",
                                      #"twoPaths",
                                      "mutual",
                                      "preferentialAttachment(2)"),
                            gofit_terms = c("edges","degree(0:15,'out')","degree(0:15,'in')","esp(0:15)"),
                            fit_terms = c("star(c(2,3))"),
                            gofit_name = "lolog_1_20")
```

21) Fit with preferential attachment term, fitting with star(2,3), and triangles.

Remove all other structural terms. It didn't work

So:
* Remove nodeCov(rank_in)
* Remove nodeCov(rank_in) and uprank

```{r, eval = TRUE}
lolog_fit_1_21 <- lolog_fit(net,
                            terms = c("edges",
                                      #"nodeCov('repeater_or_sweets_in','in')",
                                      #"nodeCov('handicapped_in','in')",
                                      #"nodeCov('rank_in','in')",
                                      #"nodeCov('rank_out','out')",
                                      #"edgeCov(edges_adj_rankdiff,'rankdiff')",
                                      #"edgeCov(edges_adj_uprank,'uprank')",
                                      #"triangles",
                                      #"star(c(2,3))",
                                      #"cTriple",
                                      #"twoPaths",
                                      #"mutual",
                                      "preferentialAttachment(1)"),
                            gofit_terms = c("edges","degree(0:15,'out')","degree(0:15,'in')","esp(0:15)"),
                            fit_terms = c("star(c(2,3))","triangles"),
                            gofit_name = "lolog_1_21")
```

22) Try to use our best LOLOG fit with some ordering.

Suspect there is some ordering process, first idea is that repeaters and sweet givers come into social
contact with other students first therefore their friendship ties form first
may or may not be plausible - see if it provides a better fit.

```{r, eval = TRUE}
repeater_or_sweets <- (net %v% "repeater_or_sweets")
repeater_or_sweets[repeater_or_sweets == 0] <- 2

lolog_fit_1_22 <- lolog_fit(net,
                            terms = c("edges",
                                      "nodeCov('repeater_or_sweets_in','in')",
                                      "nodeCov('handicapped_in','in')",
                                      "nodeCov('rank_in','in')",
                                      "nodeCov('rank_out','out')",
                                      "edgeCov(edges_adj_rankdiff,'rankdiff')",
                                      "edgeCov(edges_adj_uprank,'uprank')",
                                      #"triangles",
                                      "star(c(2,3))",
                                      "cTriple",
                                      #"twoPaths",
                                      "tTriple",
                                      "mutual"),
                            gofit_terms = c("edges","degree(0:15,'out')","degree(0:15,'in')","esp(0:15)"),
                            gofit_name = "lolog_1_22",
                            vertex_order = "repeater_or_sweets")
```
It has a similar fit to lolog without ordering

23) Try ordering based on rank

That is, since we have a clear hierarchy in the class see if 
accounting for ties for high nodes first gives a better model

```{r, eval = TRUE}
#best student is ranked as 1 so so need to flip to consider worst (i.e most social) students first
rank <- (net %v% "rank")
rank <- 54-rank

lolog_fit_1_23 <- lolog_fit(net,
                            terms = c("edges",
                                      "nodeCov('repeater_or_sweets_in','in')",
                                      "nodeCov('handicapped_in','in')",
                                      "nodeCov('rank_in','in')",
                                      "nodeCov('rank_out','out')",
                                      "edgeCov(edges_adj_rankdiff,'rankdiff')",
                                      "edgeCov(edges_adj_uprank,'uprank')",
                                      #"triangles",
                                      "star(c(2,3))",
                                      "cTriple",
                                      #"twoPaths",
                                      "tTriple",
                                      "mutual"),
                            gofit_terms = c("edges","degree(0:15,'out')","degree(0:15,'in')","esp(0:15)"),
                            gofit_name = "lolog_1_23",
                            vertex_order = "rank")
```

Doesn't seem to be an appreciably better fit than LOLOG without ordering

Would like to look at edge specified ordering process, 
i.e. consider neighbours in the ranking procedure since students sit in rank order
not supported by LOLOG currently.

### Save all the models for later

```{r, eval = TRUE}
#list making function
make_list <- function(networks,models,type,space=ls()){
  models <- rep(models,each = length(networks))
  tmp <- unlist(mapply(networks,models,FUN = function(x,y){return(paste(type,"_",x,"_",y,sep = ""))},SIMPLIFY = FALSE))  
  return(tmp)
}

fit_ergm_list <- make_list(c(1),seq(0,4,1),"ergm_fit")
ergm_list <- make_list(c(1),seq(0,4,1),"ergm")
summary_ergm_list <- make_list(c(1),seq(0,4,1),"summary_ergm")
gofit_ergm_list <- make_list(c(1),seq(0,4,1),"gofit_ergm")

fit_lolog_list <- make_list(c(1),seq(0,23,1),"lolog_fit")
lolog_list <- make_list(c(1),seq(0,23,1),"lolog")
summary_lolog_list <- make_list(c(1),seq(0,23,1),"summary_lolog")
gofit_lolog_list <- make_list(c(1),seq(0,23,1),"gofit_lolog")

#assign ergm variables for lists
for(i in ergm_list){
  a <- eval(parse(text = paste("ergm_fit",substr(i,5,nchar(i)),sep = "")))
  if(length(a) == 1 & is.na(a[1])){
    assign(paste("ergm",substr(i,5,nchar(i)),sep = ""),NA)
    assign(paste("summary_ergm",substr(i,5,nchar(i)),sep = ""),NA)
    assign(paste("gofit_ergm",substr(i,5,nchar(i)),sep = ""),NA)
  }else{
    assign(paste("ergm",substr(i,5,nchar(i)),sep = ""),eval(parse(text = paste("ergm_fit",substr(i,5,nchar(i)),"$model",sep = ""))))
    assign(paste("summary_ergm",substr(i,5,nchar(i)),sep = ""),eval(parse(text = paste("ergm_fit",substr(i,5,nchar(i)),"$summary",sep = ""))))
    assign(paste("gofit_ergm",substr(i,5,nchar(i)),sep = ""),eval(parse(text = paste("ergm_fit",substr(i,5,nchar(i)),"$gofit",sep = ""))))
  }
}

#assign lolog variables for lists
for(i in  lolog_list){
  a <- eval(parse(text = paste("lolog_fit",substr(i,6,nchar(i)),sep = "")))
  if(length(a) == 1 & is.na(a[1])){
    assign(paste("lolog",substr(i,6,nchar(i)),sep = ""),NA)
    assign(paste("summary_lolog",substr(i,6,nchar(i)),sep = ""),NA)
    assign(paste("gofit_lolog",substr(i,6,nchar(i)),sep = ""),NA)
  }else{
    assign(paste("lolog",substr(i,6,nchar(i)),sep = ""),eval(parse(text = paste("lolog_fit",substr(i,6,nchar(i)),"$model",sep = ""))))
    assign(paste("summary_lolog",substr(i,6,nchar(i)),sep = ""),eval(parse(text = paste("lolog_fit",substr(i,6,nchar(i)),"$summary",sep = ""))))
    assign(paste("gofit_lolog",substr(i,6,nchar(i)),sep = ""),eval(parse(text = paste("lolog_fit",substr(i,6,nchar(i)),"$gofit",sep = ""))))
  }
}

#save lists:
save(list= c(ergm_list,summary_ergm_list,gofit_ergm_list),file ="ergm_fit.RData")
save(list= c(lolog_list,summary_lolog_list,gofit_lolog_list),file ="lolog_fit.RData")
```

### References 

For further readings and references you can check: 

  
  + Comparing the Real-World Performance of Exponential-family Random Graph Models and Latent Order Logistic Models (2021), Duncan A. Clark and Mark S. Handcock
  
  + ergm: Fit, Simulate and Diagnose Exponential-Family Models for Networks [ergm: statnet](https://github.com/statnet/ergm)
  
  + lolog: Latent Order Logistic (LOLOG) Graph Models [lolog: statnet](https://github.com/statnet/lolog)
  
  + statnet: Statistical software for the analysis, simulation and visualization of network data [statnet](https://github.com/statnet)
